<!DOCTYPE html>
<html lang="th">

<head>
  <!-- -------------------- Meta & Title -------------------- -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - รายชื่อนักเรียน</title>

  <!-- -------------------- CSS & Icon -------------------- -->
  <link rel="stylesheet" href="/style-admindetail.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
  <div class="main p-3">
    <!-- -------------------- Header -------------------- -->
    <div class="main-header d-flex align-items-center justify-content-between mb-3">
      <div>
        <!-- ปุ่มย้อนกลับไปหน้า Admin หลัก -->
        <a href="/admin">
          <button class="btn btn-success ms-1"><i class="bi bi-arrow-left"></i></button>
        </a>
      </div>
      <h1 class="header_title fw-bold m-0">รายชื่อนักเรียน</h1>
      <div class="main-btn d-flex gap-2 align-items-center">
        <form method="GET" action="/admin_students" class="d-flex gap-2 justify-content-center align-items-center">
          <input type="text" id="search-bar" name="search" class="form-control" value="<%= search || '' %>"
            placeholder="พิมพ์ชื่อนักเรียนหรือรหัสนักเรียน...">
          <button type="submit" class="btn btn-primary">ค้นหา</button>
        </form>
        <a href="/add_students" class="btn btn-primary">+ เพิ่มนักเรียน</a>
        <a href="/add_allstudents" class="btn btn-warning">+ เพิ่มนักเรียนทั้งหมด</a>
        <button class="btn btn-danger btn-deleteall">- ลบทั้งหมด</button>
      </div>
    </div>

    <!-- -------------------- Table: รายชื่อนักเรียน -------------------- -->
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th class="text-center">ชื่อนักเรียน</th>
          <th class="text-center">ชั้น</th>
          <th class="text-center">เลขที่</th>
          <th class="text-center">อีเมลล์</th>
          <th class="text-center">รหัสผ่าน</th>
          <th class="text-center">การดำเนินการ</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(users=> { %>
          <tr>
            <td class="text-center">
              <%= users.name_users %>
            </td>
            <td class="text-center">
              <%= users.classroom %>
            </td>
            <td class="text-center">
              <%= users.number %>
            </td>
            <td class="text-center">
              <%= users.email %>
            </td>
            <td class="text-center">
              <%= users.password %>
            </td>
            <td class="text-center">
              <!-- ปุ่มแก้ไขข้อมูลนักเรียน -->
              <a href="/admin_students/edit-user/<%= encodeURIComponent(users.name_users) %>"
                class="btn btn-sm btn-info">แก้ไข</a>
              <!-- ปุ่มลบข้อมูลนักเรียน -->
              <button class="btn btn-sm btn-danger btn-delete" data-user="<%= users.name_users %>">ลบ</button>
            </td>
          </tr>
          <% }) %>
      </tbody>
    </table>
  </div>

  <!-- -------------------- Script: ลบผู้ใช้เดี่ยว/ทั้งหมด -------------------- -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // -------------------- ลบผู้ใช้เดี่ยว --------------------
      document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', () => {
          const userName = button.getAttribute('data-user');
          if (confirm(`คุณต้องการลบผู้ใช้ "${userName}" หรือไม่?`)) {
            fetch('/admin_students/delete-user', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name_users: userName })
            })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  alert(`ลบผู้ใช้ "${userName}" เรียบร้อยแล้ว`);
                  location.reload();
                } else {
                  alert(data.message || 'เกิดข้อผิดพลาด');
                }
              })
              .catch(err => {
                console.error(err);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
              });
          }
        });
      });

      // -------------------- ลบผู้ใช้ทั้งหมด --------------------
      document.querySelector('.btn-deleteall').addEventListener('click', () => {
        if (confirm('คุณต้องการลบผู้ใช้ทั้งหมดหรือไม่?')) {
          fetch('/admin_students/delete-all-users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert('ลบผู้ใช้ทั้งหมดเรียบร้อยแล้ว');
                location.reload();
              } else {
                alert(data.message || 'เกิดข้อผิดพลาด');
              }
            })
            .catch(err => {
              console.error(err);
              alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            });
        }
      });
    });
  </script>
</body>

</html>