<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>แก้ไขการลงทะเบียน</title>
    <link rel="stylesheet" href="/style-edit.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <% if (message) { %>
        <p style="color:red;">
            <%= message %>
        </p>
        <% } %>

            <main class="main">
                <div class="head-menu">
                    <a href="/admin_register">
                        <button class="btn btn-success ms-1">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    </a>
                    <h1>แก้ไขการลงทะเบียน</h1>
                </div>
                <form method="POST"
                    action="/admin_register/edit-registration/<%= encodeURIComponent(registration.name_users) %>">
                    <label for="name_users">ชื่อผู้ใช้:</label>
                    <input type="text" id="name_users" name="name_users" value="<%= registration.name_users %>"
                        required><br>

                    <label for="classroom">ห้องเรียน:</label>
                    <input type="text" id="classroom" name="classroom" value="<%= registration.classroom %>"
                        required><br>

                    <label for="number">เลขที่:</label>
                    <input type="number" id="number" name="number" value="<%= registration.number %>" required><br>

                    <label for="category">กลุ่มสาระ:</label>
                    <select id="category" name="category" required>
                        <option value="">-- เลือกกลุ่มสาระ --</option>
                    </select><br>

                    <label for="club_name">ชื่อชุมนุม:</label>
                    <select id="club_name" name="club_name" required>
                        <option value="">-- เลือกชุมนุม --</option>
                    </select><br>

                    <label for="name_teachers">ชื่อครูผู้สอน:</label>
                    <input type="text" id="name_teachers" name="name_teachers" value="<%= registration.name_teachers %>"
                        required><br>

                    <label for="conditions">เงื่อนไขการรับ:</label>
                    <input type="text" id="conditions" name="conditions" value="<%= registration.conditions %>"
                        required><br>

                    <button type="submit">บันทึกการแก้ไข</button>
                </form>
            </main>

            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const categorySelect = document.getElementById("category");
                    const clubSelect = document.getElementById("club_name");
                    const teacherInput = document.getElementById("name_teachers");
                    const conditionsInput = document.getElementById("conditions");

                    const currentCategory = "<%= registration.category || '' %>";
                    const currentClub = "<%= registration.club_name %>";

                    // โหลด category
                    fetch('/api/categories')
                        .then(res => res.json())
                        .then(data => {
                            data.forEach(cat => {
                                const opt = document.createElement("option");
                                opt.value = cat.category;
                                opt.textContent = cat.category;
                                if (cat.category === currentCategory) opt.selected = true;
                                categorySelect.appendChild(opt);
                            });
                            if (currentCategory) loadClubs(currentCategory);
                        });

                    // โหลด clubs ตาม category
                    function loadClubs(category) {
                        clubSelect.innerHTML = `<option value="">-- เลือกชุมนุม --</option>`;
                        if (!category) return;
                        fetch(`/api/clubs/${category}`)
                            .then(res => res.json())
                            .then(data => {
                                data.forEach(club => {
                                    const opt = document.createElement("option");
                                    opt.value = club.name;
                                    opt.textContent = club.name;
                                    opt.dataset.teacher = club.name_teachers;
                                    opt.dataset.conditions = club.conditions;
                                    if (club.name === currentClub) {
                                        opt.selected = true;
                                        teacherInput.value = club.name_teachers;
                                        conditionsInput.value = club.conditions;
                                    }
                                    clubSelect.appendChild(opt);
                                });
                            });
                    }

                    categorySelect.addEventListener("change", () => {
                        loadClubs(categorySelect.value);
                        teacherInput.value = "";
                        conditionsInput.value = "";
                    });

                    clubSelect.addEventListener("change", () => {
                        const selected = clubSelect.options[clubSelect.selectedIndex];
                        teacherInput.value = selected.dataset.teacher || "";
                        conditionsInput.value = selected.dataset.conditions || "";
                    });
                });
            </script>
</body>

</html>