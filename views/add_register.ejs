<!DOCTYPE html>
<html lang="th">

<head>
    <!-- -------------------- Meta & Title -------------------- -->
    <meta charset="UTF-8">
    <title>เพิ่มนักเรียนเข้าชุมนุม</title>

    <!-- -------------------- CSS & Icon -------------------- -->
    <link rel="stylesheet" href="/style-add.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body>
    <!-- -------------------- Message Alert -------------------- -->
    <% if (message) { %>
        <p style="color: red;">
            <%= message %>
        </p>
    <% } %>

    <main>
        <!-- -------------------- Header Menu -------------------- -->
        <div class="head-menu-special2">
            <a href="/admin_register">
                <button class="btn btn-success ms-1">
                    <i class="bi bi-arrow-left"></i>
                </button>
            </a>
            <h2>เพิ่มนักเรียนเข้าชุมนุม</h2>
        </div>

        <!-- -------------------- Add Register Form -------------------- -->
        <form action="/add_register" method="POST">
            <label for="email">อีเมลนักเรียน:</label>
            <input type="email" id="email" name="email" required><br>

            <label for="name_users">ชื่อนักเรียน:</label>
            <input type="text" id="name_users" name="name_users" required><br>

            <label for="classroom">ระดับชั้น:</label>
            <input type="text" id="classroom" name="classroom" required><br>

            <label for="number">เลขที่:</label>
            <input type="number" id="number" name="number" required><br>

            <label for="category">กลุ่มสาระ:</label>
            <select id="category" name="category" required>
            <option value="">-- เลือกกลุ่มสาระ --</option>
            </select><br>

            <label for="club_name">ชื่อชุมนุม:</label>
            <select id="club_name" name="club_name" required>
            <option value="">-- เลือกชุมนุม --</option>
            </select><br>

            <label for="name_teachers">ชื่อครูผู้สอน:</label>
            <input type="text" id="name_teachers" name="name_teachers" required><br>

            <button type="submit">เพิ่มนักเรียนเข้าชุมนุม</button>
        </form>
    </main>

    <!-- -------------------- Script: Dynamic Form Logic -------------------- -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const emailInput = document.getElementById("email");
            const nameInput = document.getElementById("name_users");
            const classroomInput = document.getElementById("classroom");
            const numberInput = document.getElementById("number");
            const teacherInput = document.getElementById("name_teachers");
            const categorySelect = document.getElementById("category");
            const clubSelect = document.getElementById("club_name");

            // -------------------- Load Category Options --------------------
            fetch('/api/categories')
                .then(res => res.json())
                .then(data => {
                    data.forEach(cat => {
                        const opt = document.createElement("option");
                        opt.value = cat.category;
                        opt.textContent = cat.category;
                        categorySelect.appendChild(opt);
                    });
                });

            // -------------------- Autofill Student Info by Email --------------------
            emailInput.addEventListener("blur", () => {
                const email = emailInput.value.trim();
                if (!email) return;
                fetch(`/api/user/${email}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.name_users) nameInput.value = data.name_users;
                        if (data.classroom) classroomInput.value = data.classroom;
                        if (data.number) numberInput.value = data.number;
                    });
            });

            // -------------------- Load Clubs by Category --------------------
            categorySelect.addEventListener("change", () => {
                const category = categorySelect.value;
                clubSelect.innerHTML = `<option value="">-- เลือกชุมนุม --</option>`;
                if (!category) return;
                fetch(`/api/clubs/${category}`)
                    .then(res => res.json())
                    .then(data => {
                        data.forEach(club => {
                            const opt = document.createElement("option");
                            opt.value = club.name;
                            opt.textContent = club.name;
                            opt.dataset.teacher = club.name_teachers;
                            clubSelect.appendChild(opt);
                        });
                    });
            });

            // -------------------- Autofill Teacher Name by Club --------------------
            clubSelect.addEventListener("change", () => {
                const selected = clubSelect.options[clubSelect.selectedIndex];
                teacherInput.value = selected.dataset.teacher || "";
            });
        });
    </script>
</body>

</html>